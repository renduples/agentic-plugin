name: Build and Release Plugin

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create plugin zip
        run: |
          # Create a clean directory for the plugin
          mkdir -p build/agentic-plugin
          
          # Copy plugin files (exclude dev/test files)
          cp agentic-plugin.php build/agentic-plugin/
          cp readme.txt build/agentic-plugin/
          cp -r admin build/agentic-plugin/
          cp -r assets build/agentic-plugin/
          cp -r includes build/agentic-plugin/
          cp -r library build/agentic-plugin/
          cp -r templates build/agentic-plugin/
          
          # Copy vendor if exists (for production dependencies)
          if [ -d "vendor" ]; then
            cp -r vendor build/agentic-plugin/
          fi
          
          # Remove dev files from the build
          find build/agentic-plugin -name ".git*" -type f -delete
          find build/agentic-plugin -name ".DS_Store" -type f -delete
          find build/agentic-plugin -name "*.log" -type f -delete
          find build/agentic-plugin -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find build/agentic-plugin -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
          
          # Create the zip
          cd build
          zip -r ../agentic-plugin.zip agentic-plugin
          cd ..
          
          # Also create versioned zip
          cp agentic-plugin.zip agentic-plugin-${{ steps.version.outputs.VERSION }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Agent Builder v${{ steps.version.outputs.VERSION }}
          body: |
            ## Agent Builder v${{ steps.version.outputs.VERSION }}
            
            ### Installation
            1. Download `agentic-plugin.zip`
            2. In WordPress admin, go to Plugins → Add New → Upload Plugin
            3. Upload the zip file and activate
            
            ### WP-CLI Installation
            ```bash
            wp plugin install https://github.com/renduples/agent-builder/releases/latest/download/agentic-plugin.zip --activate
            ```
            
            See [documentation](https://agentic-plugin.com/) for setup instructions.
          files: |
            agentic-plugin.zip
            agentic-plugin-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
